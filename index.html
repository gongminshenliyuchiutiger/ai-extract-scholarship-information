<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çåŠ©å­¸é‡‘ç”³è«‹è³‡è¨Šç¥æå–ç³»çµ±</title> <!-- éœæ…‹å®šç¾©çš„ç€è¦½å™¨æ¨™é¡Œ -->
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- pdf.js (for reading PDFs) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    <!-- Tesseract.js (for OCR on images) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
        /* Base and Dark Mode Variables */
        :root {
            --bg-color: #f4f7f9;
            --panel-bg: #ffffff;
            --text-color: #333;
            --heading-color: #2c3e50;
            --muted-color: #7f8c8d;
            --primary-color: #2563eb; /* Tailwind blue-600 */
            --primary-hover: #1d4ed8; /* Tailwind blue-700 */
            --secondary-color: #4b5563; /* For buttons like Markdown copy */
            --secondary-hover: #1f2937;
            --border-color: #e3e8ee;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --skeleton-bg: #e0e0e0;
            --font-ui: 'Poppins', 'Noto Sans TC', sans-serif;
            --font-body: 'Noto Sans TC', serif;
        }

        [data-theme="dark"] {
            --bg-color: #2c3e50;
            --panel-bg: #34495e;
            --text-color: #ecf0f1; /* Light text for dark mode */
            --heading-color: #ffffff;
            --muted-color: #95a5a6;
            --border-color: #4b6584;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --skeleton-bg: #4a627a;
            --input-bg: #4a5c70; /* Darker input background */
            --input-text: #ecf0f1; /* Light text for inputs */
            --input-border: #627b91; /* Border for inputs */
        }

        /* Base Body Styles */
        html {
            /* å…è¨±æ•´å€‹ HTML æ ¹å…ƒç´ æ»¾å‹•ï¼Œé è¨­æƒ…æ³ä¸‹ body çš„æ»¾å‹•æ¢æœƒåœ¨ html ä¸Šé¡¯ç¤º */
            overflow-y: auto; 
            overflow-x: hidden; /* éš±è—æ°´å¹³æ»¾å‹•æ¢ */
        }

        body { 
            font-family: var(--font-ui); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            transition: background-color 0.3s, color 0.3s; 
            line-height: 1.6; 
            min-height: 100vh; /* ç¢ºä¿ body è‡³å°‘ä½”æ»¿è¦–çª—é«˜åº¦ */
            display: flex;
            flex-direction: column;
            position: relative; /* For floating emojis */
            /* ç§»é™¤ body ä¸Šçš„ overflow: hidden; */
            /* è®“ HTML å…ƒç´ ä¾†è™•ç†æ»¾å‹•ï¼Œæˆ–è€…å°‡ body è¨­ç½®ç‚º auto */
            /* å¦‚æœ body å…§å®¹è¶…é 100vhï¼Œå‰‡å…è¨±æ»¾å‹• */
            overflow-y: auto; 
            overflow-x: hidden; /* ä¿æŒéš±è— body å…§çš„æ°´å¹³æ»¾å‹•ï¼Œé¿å…èˆ‡ HTML è¡çª */
        }

        .container { flex-grow: 1; z-index: 10; position: relative; } /* Allow container to grow, pushing footer down, put above emojis */

        /* Panel Styles */
        .panel { 
            background: var(--panel-bg); 
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border-color); 
            transition: background-color 0.3s, border-color 0.3s; 
            display: flex; 
            flex-direction: column; 
        }
        .panel-header { 
            font-size: 1.5rem; 
            font-weight: 600; 
            color: var(--heading-color); 
            margin-bottom: 20px; 
        }

        /* Buttons */
        .btn { 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem; 
            font-weight: 500; 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            border: 1px solid transparent; 
        }
        .btn-primary { 
            background: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color); 
        }
        .btn-primary:hover:not(:disabled) { 
            background: var(--primary-hover); 
            border-color: var(--primary-hover); 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .btn-secondary-custom { /* For Markdown copy button */
            background: var(--secondary-color); 
            color: white; 
            border-color: var(--secondary-color); 
            padding: 0.5rem 1rem; /* Smaller padding for inline buttons */
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
        .btn-secondary-custom:hover:not(:disabled) { 
            background: var(--secondary-hover); 
            border-color: var(--secondary-hover); 
            transform: translateY(-1px); /* Slightly less aggressive hover */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .btn-outline { 
            background: none; 
            border-color: var(--border-color); 
            color: var(--text-color); 
        }
        .btn-outline:hover:not(:disabled) { 
            background: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color); 
        }
        .btn:disabled { 
            background: var(--muted-color); 
            color: #fff; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
            border-color: var(--muted-color); 
        }

        /* Drop Zone */
        #drop-zone { 
            border: 2px dashed var(--border-color); 
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            text-align: center; 
            transition: all 0.3s ease; 
            background-color: var(--bg-color); 
            cursor: pointer; 
            position: relative; /* Essential for overlaying file input */
            overflow: hidden; 
        }
        #drop-zone.drag-over { 
            border-color: var(--primary-color); 
            background-color: var(--bg-color); 
        }
        /* File input covers drop-zone, is transparent and functional for both click and drag/drop */
        #file-upload {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0; /* Fully transparent */
            cursor: pointer;
            z-index: 10; /* Ensure it's above other drop-zone content for clicks */
            pointer-events: auto; /* Crucial for ensuring it receives pointer events */
        }
        
        /* Modals */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.6); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            animation: fadeIn 0.3s; 
        }
        /* Custom modal for API key tutorial - ensure dark mode compatibility */
        .modal-content-custom { 
            background: var(--panel-bg); 
            padding: 30px; 
            border-radius: 16px; 
            max-width: 600px; 
            width: 90%; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            max-height: 80vh; 
            overflow-y: auto; 
            color: var(--text-color); /* Apply theme text color */
        } 
        .modal-close { 
            position: absolute; 
            top: 10px; 
            right: 15px; 
            font-size: 1.8rem; 
            color: var(--muted-color); 
            cursor: pointer; 
            transition: transform 0.2s; 
        }
        .modal-close:hover { 
            transform: scale(1.2); 
        }
        .modal-content-custom a { 
            color: var(--primary-color); 
            text-decoration: none; 
        }
        .modal-content-custom a:hover { 
            text-decoration: underline; 
        }

        /* Theme Switcher */
        .theme-switcher {
            position: absolute; 
            top: 50%; 
            right: 0; 
            transform: translateY(-50%);
            background: var(--panel-bg); 
            border: 1px solid var(--border-color);
            border-radius: 50px; 
            padding: 5px; 
            cursor: pointer; 
            font-size: 1.2rem;
            width: 40px; 
            height: 40px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            transition: all 0.3s; 
            color: var(--text-color);
        }
        .theme-switcher:hover { 
            transform: translateY(-50%) scale(1.1) rotate(15deg); 
        }

        /* Mascot */
        #mascot {
            position: fixed;
            bottom: 15px;
            left: 15px;
            width: clamp(80px, 12vw, 120px);
            z-index: 998;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.2));
        }
        #mascot:hover {
            transform: scale(1.1);
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: scale(1.1) translate3d(-1px, 0, 0); }
            20%, 80% { transform: scale(1.1) translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: scale(1.1) translate3d(-3px, 0, 0); }
            40%, 60% { transform: scale(1.1) translate3d(3px, 0, 0); }
        }
        .particle {
            position: fixed;
            pointer-events: none;
            border-radius: 50%;
            opacity: 0;
            z-index: 1001;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 768px) { #mascot { width: 80px; } }

        /* General form input styling */
        .form-control { 
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--panel-bg); /* Match panel background */
            color: var(--text-color); /* Match theme text color */
            transition: all 0.2s ease-in-out;
        }
        .form-control:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); 
            border-color: var(--primary-color);
        }
        /* Dark mode specific for form controls */
        [data-theme="dark"] .form-control {
            background-color: var(--input-bg);
            color: var(--input-text);
            border-color: var(--input-border);
        }
        
        /* Markdown Output Textarea */
        #markdown-output {
            resize: vertical; /* Allow vertical resizing */
            min-height: 150px; /* Minimum height */
            font-family: 'Noto Sans TC', monospace; /* More readable font for text content, monospace for code-like */
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-wrap: break-word; /* Break long words */
            height: 100%; /* Fill available height */
        }

        /* Dark mode compatibility for specific text elements */
        header h1 {
            color: var(--heading-color);
        }
        header p {
            color: var(--muted-color);
        }
        #status-log {
            background-color: var(--input-bg); /* Use input background for log */
            color: var(--input-text); /* Ensure base text color is light in dark mode for any direct content */
            border-color: var(--border-color);
            /* Custom scrollbar for Webkit browsers */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: var(--primary-color) var(--input-bg); /* Firefox scrollbar color */
        }
        #status-log::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
            height: 8px; /* Height of horizontal scrollbar */
        }
        #status-log::-webkit-scrollbar-track {
            background: var(--input-bg); /* Track background */
            border-radius: 10px;
        }
        #status-log::-webkit-scrollbar-thumb {
            background: var(--primary-color); /* Scrollbar thumb color */
            border-radius: 10px;
            border: 2px solid var(--input-bg); /* Add border for better contrast with track */
        }
        #status-log::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover); /* Hover color */
        }

        /* API Key label text color override */
        label[for="user-api-key"] {
            color: var(--text-color); /* Ensure this label uses theme text color */
        }
        /* API Key Modal text to ensure readability in dark mode */
        #api-key-modal .modal-content-custom .space-y-3 p,
        #api-key-modal .modal-content-custom ol li,
        #api-key-modal .modal-content-custom strong {
            color: var(--text-color); 
        }
        #api-key-modal .modal-content-custom a {
             color: var(--primary-color);
        }
        #api-key-modal .modal-content-custom .text-yellow-700 {
            /* In dark mode, ensure this is a bright variant of yellow */
            color: var(--text-color); /* Change to theme text color to ensure readability */
        }
        #api-key-modal .modal-content-custom .bg-yellow-50 {
            background-color: var(--input-bg); /* Make warning background dark */
        }

        /* Floating Emojis */
        #floating-emojis-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Do not block interaction with content */
            z-index: 1; /* Below content, above body background */
            overflow: hidden; /* **é—œéµä¿®æ­£ï¼šå°‡æº¢å‡ºéš±è—åœ¨é€™è£¡ï¼Œé˜²æ­¢ emoji å½±éŸ¿ body æ»¾å‹•** */
        }

        .floating-emoji {
            position: absolute;
            font-size: clamp(1.5rem, 3vw, 3rem); /* Responsive font size */
            opacity: 0;
            animation: float-up linear forwards;
            white-space: nowrap; /* Prevent emoji from wrapping */
            transform-origin: bottom center; /* For rotation */
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.1)); /* Subtle shadow for visibility */
            /* Removed default color here, using inline Tailwind colors for variety */
        }

        @keyframes float-up {
            0% {
                transform: translateY(0vh) scale(0.5) rotateZ(0deg);
                opacity: 0;
            }
            20% {
                opacity: 0.8;
            }
            80% {
                opacity: 0.8;
                transform: translateY(-80vh) scale(1.0) rotateZ(360deg);
            }
            100% {
                transform: translateY(-100vh) scale(1.2) rotateZ(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="text-gray-800" data-theme="light">

    <!-- Floating Emojis Container -->
    <div id="floating-emojis-container"></div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8 text-center relative">
            <h1 class="text-4xl font-bold mb-2 flex items-center justify-center gap-3"><i class="fa-solid fa-graduation-cap text-blue-600"></i>çåŠ©å­¸é‡‘ç”³è«‹è³‡è¨Šç¥æå–ç³»çµ±</h1>
            <p class="text-lg">æ™ºæ…§åˆ†æ PDF/åœ–ç‰‡æ–‡ä»¶ï¼Œè‡ªå‹•ç¥æå–çåŠ©å­¸é‡‘è³‡è¨Š</p>
            <button class="theme-switcher" id="theme-toggle" title="åˆ‡æ›ä¸»é¡Œ"><i class="fa-solid fa-sun"></i></button>
        </header>

        <div id="ai-panel-container"> <!-- This container is always visible -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Panel: Upload and Settings -->
                <section class="panel upload-panel">
                    <h2 class="panel-header">ä¸Šå‚³æª”æ¡ˆèˆ‡è¨­å®š</h2>
                    <div id="drop-zone" class="mb-4">
                        <i class="fas fa-file-arrow-up text-5xl text-blue-500 mb-4"></i>
                        <p class="text-gray-600 dark:text-gray-300">å°‡ PDF/åœ–ç‰‡ æª”æ¡ˆæ‹–æ›³è‡³æ­¤ï¼Œæˆ–é»æ“Šé¸æ“‡ (å¯å¤šé¸)</p>
                        <!-- File input covers the drop zone, is transparent and functional -->
                        <input type="file" id="file-upload" accept=".pdf,image/*" multiple> 
                    </div>

                    <div id="file-list" class="space-y-2 mb-4">
                        <!-- Uploaded file items will be inserted here -->
                    </div>
                    
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label for="user-api-key" class="font-medium text-gray-700 dark:text-gray-200">Google Gemini API é‡‘é‘°</label>
                            <span id="api-tutorial-link" class="text-sm text-blue-600 hover:underline cursor-pointer">(å¦‚ä½•å–å¾—ï¼Ÿ)</span>
                        </div>
                        <input type="password" id="user-api-key" placeholder="è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°" class="form-control">
                        <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">é‡‘é‘°åƒ…å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³è‡³ä»»ä½•ä¼ºæœå™¨ã€‚</p>
                    </div>
                    
                    <div class="mt-auto pt-6 border-t border-gray-200 dark:border-gray-700 flex flex-wrap gap-4">
                        <button id="clear-all-btn" class="btn btn-outline flex-grow">
                            <i class="fa-solid fa-eraser"></i> æ¸…ç©ºæ‰€æœ‰
                        </button>
                        <button id="start-extraction-btn" class="btn btn-primary flex-grow text-lg" disabled>
                            <i class="fa-solid fa-brain"></i> é–‹å§‹AIç¥æå–
                        </button>
                    </div>

                    <div class="border-t pt-4 mt-6">
                        <label for="user-api-key" class="font-medium text-gray-700 dark:text-gray-200">è™•ç†ç‹€æ…‹</label>
                        <!-- ç¢ºä¿ h-32 æä¾›å›ºå®šé«˜åº¦ï¼Œä¸” overflow-y-auto å•Ÿç”¨æ»¾å‹• -->
                        <div id="status-log" class="w-full h-32 p-3 border border-gray-200 rounded-lg font-mono text-sm overflow-y-auto">
                            <!-- åˆå§‹è¨Šæ¯æœƒç”± JS å¯«å…¥ -->
                        </div>
                    </div>
                </section>

                <!-- Right Panel: AI Output Editor and Download -->
                <section class="panel results-panel">
                    <h2 class="panel-header">AIç¥æå–çµæœ</h2>
                    <!-- Markdown Output Area -->
                    <div class="flex-grow flex flex-col space-y-4">
                        <textarea id="markdown-output" class="form-control flex-grow" rows="15" placeholder="AIç¥æå–çµæœå°‡ä»¥ Markdown æ ¼å¼é¡¯ç¤ºæ–¼æ­¤ï¼Œæ‚¨å¯ä»¥ç·¨è¼¯å¾Œè¤‡è£½..."></textarea>
                        <button id="copy-markdown-btn" class="btn btn-secondary-custom">
                            <i class="fa-solid fa-clipboard"></i> è¤‡è£½ Markdown
                        </button>
                    </div>
                </section>
            </div>
        </div>

    </div>
    
    <footer class="text-center mt-10 text-gray-500 dark:text-gray-400 text-sm pb-6">Copyright Â© Liyuchiutiger Gongminshen</footer>

    <img id="mascot" src="image/LiyuChillGuy.svg" alt="LiyuChillGuy Mascot">

    <!-- API Key Modal -->
    <div class="modal-overlay" id="api-key-modal">
        <div class="modal-content-custom">
            <span class="modal-close" id="api-key-modal-close">&times;</span>
            <h3 class="text-xl font-bold text-blue-600 mb-4">å¦‚ä½•å–å¾—å…è²»çš„ Google Gemini API é‡‘é‘°ï¼Ÿ</h3>
            <div class="space-y-3"> 
                <p>æŒ‰ç…§ä»¥ä¸‹ç°¡å–®æ­¥é©Ÿï¼Œå³å¯å–å¾—æ‚¨è‡ªå·±çš„å…è²»é‡‘é‘°ï¼š</p>
                <ol class="list-decimal list-inside space-y-2">
                    <li>å‰å¾€ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-semibold">Google AI Studio çš„ API é‡‘é‘°é é¢</a>ã€‚</li>
                    <li>ä½¿ç”¨æ‚¨çš„ Google å¸³è™Ÿç™»å…¥ã€‚</li>
                    <li>é»æ“Šé é¢ä¸Šçš„ <strong>ã€Œå»ºç«‹ API é‡‘é‘°ã€(Create API key)</strong> æŒ‰éˆ•ã€‚</li>
                    <li>ç³»çµ±æœƒç«‹å³ç”¢ç”Ÿä¸€çµ„æ–°çš„é‡‘é‘°ã€‚é»æ“Šé‡‘é‘°æ—é‚Šçš„è¤‡è£½åœ–ç¤ºã€‚</li>
                    <li>å›åˆ°æœ¬é é¢ï¼Œå°‡è¤‡è£½çš„é‡‘é‘°è²¼åˆ°è¼¸å…¥æ¡†ä¸­å³å¯ï¼</li>
                </ol>
                <p class="text-sm text-yellow-700 bg-yellow-50 p-3 rounded-lg dark:bg-yellow-900 dark:text-yellow-200">
                    <strong>æé†’ï¼š</strong>è«‹å¦¥å–„ä¿ç®¡æ‚¨çš„ API é‡‘é‘°ï¼Œä¸è¦èˆ‡ä»–äººåˆ†äº«ã€‚AI æœå‹™æœƒæ¶ˆè€—ä¸€å®šçš„é¡åº¦ã€‚
                </p>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    'use strict';

    const ui = {
        themeToggle: document.getElementById('theme-toggle'),
        dropZone: document.getElementById('drop-zone'),
        fileUpload: document.getElementById('file-upload'), 
        fileList: document.getElementById('file-list'),
        apiKeyInput: document.getElementById('user-api-key'),
        statusLog: document.getElementById('status-log'),
        startExtractionBtn: document.getElementById('start-extraction-btn'),
        clearAllBtn: document.getElementById('clear-all-btn'),
        apiKeyModal: document.getElementById('api-key-modal'),
        openApiKeyModalLink: document.getElementById('api-tutorial-link'),
        closeApiKeyModalBtn: document.getElementById('api-key-modal-close'),
        mascot: document.getElementById('mascot'),
        markdownOutput: document.getElementById('markdown-output'), // Reference to the textarea
        copyMarkdownBtn: document.getElementById('copy-markdown-btn'), // Reference to copy button
        floatingEmojisContainer: document.getElementById('floating-emojis-container'), // Floating emojis container
    };

    const state = {
        files: new Map(), // Map<id, { file: File, id: string, status: string, text: string | null, data: object[] | null }>
        fileIdCounter: 0,
        allExtractedResults: [], // Holds results from AI before displaying
        currentUser: { name: 'åŒ¿åä½¿ç”¨è€…', role: 'å…¬é–‹ä½¿ç”¨è€…' } // For console logging
    };

    const libraries = {
        pdfjsLib: window.pdfjsLib,
        Tesseract: window.Tesseract,
    };

    // --- Mascot & Theme Toggle Logic ---
    const audioManager = { 
        ctx: null,
        init: function() {
            try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } 
            catch (e) { console.error("Web Audio API is not supported."); this.ctx = null; }
        },
        _playSoundNode: function(type, frequency, duration, volume, rampTargetFreq) {
            if (!this.ctx) return;
            const oscillator = this.ctx.createOscillator();
            const gainNode = this.ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(this.ctx.destination);
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, this.ctx.currentTime);
            if (rampTargetFreq) oscillator.frequency.linearRampToValueAtTime(rampTargetFreq, this.ctx.currentTime + duration * 0.8);
            gainNode.gain.setValueAtTime(volume, this.ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + duration);
            oscillator.start(this.ctx.currentTime);
            oscillator.stop(this.ctx.currentTime + duration);
        },
        play: async function(soundName) {
            if (!this.ctx) return;
            if (this.ctx.state === 'suspended') { try { await this.ctx.resume(); } catch (e) { console.error("Failed to resume AudioContext:", e); return; } }
            if (soundName === 'sparkle') {
                this._playSoundNode('triangle', 1500, 0.1, 0.07, 2500);
                setTimeout(() => this._playSoundNode('sine', 2000, 0.1, 0.05), 80);
            }
        }
    };
    audioManager.init();

    function createParticles(x, y) {
        const particleCount = 20;
        const colors = ['#3498db', '#2ecc71', '#f1c40f', '#9b59b6']; 
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            document.body.appendChild(particle);
            const size = Math.random() * 8 + 5; 
            particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            const angle = Math.random() * Math.PI * 2;
            const distance = Math.random() * 80 + 50; 
            const endX = Math.cos(angle) * distance;
            const endY = Math.sin(angle) * distance;
            particle.style.left = `${x - size / 2}px`;
            particle.style.top = `${y - size / 2}px`;
            const animation = particle.animate(
                [{ transform: 'translate(0, 0) scale(1)', opacity: 1 }, { transform: `translate(${endX}px, ${endY}px) scale(0)`, opacity: 0 }],
                { duration: Math.random() * 600 + 400, easing: 'cubic-bezier(0.1, 0.9, 0.2, 1)', fill: 'forwards' }
            );
            animation.onfinish = () => particle.remove();
        }
    }

    if (ui.mascot) {
        ui.mascot.addEventListener('click', (e) => {
            audioManager.play('sparkle');
            const rect = ui.mascot.getBoundingClientRect();
            createParticles(rect.left + rect.width / 2, rect.top + rect.height / 2);
        });
    }

    function toggleTheme() {
        const newTheme = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) { ui.themeToggle.innerHTML = theme === 'light' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>'; }
    // --- End Mascot & Theme Toggle Logic ---

    // --- Floating Emojis Logic ---
    // Font Awesome icons for floating elements, including academic and stationery themes
    const floatingEmojis = [
        '<i class="fa-solid fa-graduation-cap text-blue-500"></i>', // å­¸ä½å¸½
        '<i class="fa-solid fa-money-bill-transfer text-green-500"></i>', // éŒ¢ã€è£œåŠ©
        '<i class="fa-solid fa-lightbulb text-yellow-500"></i>', // ç‡ˆæ³¡ï¼Œé»å­
        '<i class="fa-solid fa-book-open text-purple-500"></i>', // æ‰“é–‹çš„æ›¸
        '<i class="fa-solid fa-pencil text-red-500"></i>', // é‰›ç­†
        '<i class="fa-solid fa-scroll text-orange-500"></i>', // å·è»¸ï¼Œæ–‡ä»¶
        '<i class="fa-solid fa-award text-pink-500"></i>', // çç« 
        '<i class="fa-solid fa-star text-teal-500"></i>', // æ˜Ÿæ˜Ÿ
        '<i class="fa-solid fa-file-lines text-gray-500"></i>', // æ–‡ä»¶å¤¾
        '<i class="fa-solid fa-calculator text-indigo-500"></i>', // è¨ˆç®—æ©Ÿ
        '<i class="fa-solid fa-paperclip text-lime-500"></i>', // è¿´ç´‹é‡
        '<i class="fa-solid fa-bookmark text-amber-500"></i>', // æ›¸ç±¤
        '<i class="fa-solid fa-pen-nib text-cyan-500"></i>', // é‹¼ç­†
        '<i class="fa-solid fa-compass-drafting text-emerald-500"></i>', // åœ“è¦
        '<i class="fa-solid fa-ruler-combined text-violet-500"></i>', // å°ºå­å’Œé‰›ç­†
        '<i class="fa-solid fa-briefcase text-zinc-500"></i>', // å…¬äº‹åŒ… (ä»£è¡¨å°ˆæ¥­)
        '<i class="fa-solid fa-trophy text-yellow-600"></i>', // çæ¯
        '<i class="fa-solid fa-sack-dollar text-green-600"></i>', // éŒ¢è¢‹
        '<i class="fa-solid fa-file-invoice text-blue-400"></i>', // ç™¼ç¥¨æ–‡ä»¶
        '<i class="fa-solid fa-feather-pointed text-brown-500"></i>', // ç¾½æ¯›ç­†
    ];
    let emojiInterval;

    function createFloatingEmoji() {
        if (!ui.floatingEmojisContainer) return;

        const emojiEl = document.createElement('span');
        emojiEl.classList.add('floating-emoji');
        // ä½¿ç”¨ innerHTML ä¾†æ’å…¥ Font Awesome åœ–ç¤º
        emojiEl.innerHTML = floatingEmojis[Math.floor(Math.random() * floatingEmojis.length)];
        
        // Randomize initial position (start from bottom, across width)
        const startX = Math.random() * 100; // 0-100vw
        emojiEl.style.left = `${startX}vw`;
        emojiEl.style.bottom = `${-10 - Math.random() * 10}vh`; // Start slightly below screen

        // Randomize animation duration and delay
        const duration = 8 + Math.random() * 7; // 8 to 15 seconds
        const delay = Math.random() * 3; // 0 to 3 seconds delay
        emojiEl.style.animationDuration = `${duration}s`;
        emojiEl.style.animationDelay = `${delay}s`;
        
        // Randomize initial rotation for a more natural look
        const initialRotation = Math.random() * 360;
        emojiEl.style.transform = `translateY(0vh) scale(0.5) rotateZ(${initialRotation}deg)`;

        ui.floatingEmojisContainer.appendChild(emojiEl);

        // Remove emoji after animation finishes to prevent DOM clutter
        emojiEl.addEventListener('animationend', () => {
            emojiEl.remove();
        });
    }

    function startFloatingEmojis() {
        // Clear any existing interval to prevent duplicates
        if (emojiInterval) clearInterval(emojiInterval);
        // Create an emoji immediately, then every X seconds
        createFloatingEmoji(); 
        emojiInterval = setInterval(createFloatingEmoji, 1500 + Math.random() * 1000); // Create every 1.5-2.5 seconds
    }

    function stopFloatingEmojis() {
        if (emojiInterval) {
            clearInterval(emojiInterval);
            emojiInterval = null;
        }
        // Immediately remove all floating emojis
        if (ui.floatingEmojisContainer) {
            ui.floatingEmojisContainer.innerHTML = '';
        }
    }
    // --- End Floating Emojis Logic ---


    // Initial setup when the page loads
    function init() {
        // Load theme from localStorage, default to 'light'
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        // ç¢ºä¿åˆå§‹è¨Šæ¯ä¹Ÿé¡¯ç¤ºåœ¨ç‹€æ…‹æ—¥èªŒä¸­
        logStatus('ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œè«‹ä¸Šå‚³ PDF æˆ–åœ–ç‰‡æª”æ¡ˆã€‚', 'info');
        
        bindEvents();
        updateExtractionButtonState();
        showWelcomeScreen(); // This will now correctly use markdownOutput

        startFloatingEmojis(); // Start the background floating emojis
    }

    // Bind all event listeners
    function bindEvents() {
        ui.themeToggle.addEventListener('click', toggleTheme);

        // Drag and Drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => ui.dropZone.addEventListener(e, preventDefaults, false));
        ['dragenter', 'dragover'].forEach(e => ui.dropZone.addEventListener(e, () => ui.dropZone.classList.add('drag-over'), false));
        ['dragleave', 'drop'].forEach(e => ui.dropZone.addEventListener(e, () => ui.dropZone.classList.remove('drag-over'), false));
        
        // Handle drop event: assign files to input and trigger change event
        ui.dropZone.addEventListener('drop', e => {
            if (e.dataTransfer.files.length > 0) {
                ui.fileUpload.files = e.dataTransfer.files; 
                const changeEvent = new Event('change');
                ui.fileUpload.dispatchEvent(changeEvent); // Manually dispatch change event
            }
        }, false);
        
        // Handle file input change (for both click and drop events)
        ui.fileUpload.addEventListener('change', e => {
            if (e.target.files.length > 0) {
                logActivity(state.currentUser.name, state.currentUser.role, 'æª”æ¡ˆä¸Šå‚³', `ä¸Šå‚³ ${e.target.files.length} å€‹æª”æ¡ˆ`);
            }
            handleFiles(e.target.files);
            // Clear the input value to allow selecting the same file again
            e.target.value = ''; 
        });

        // Buttons
        ui.startExtractionBtn.addEventListener('click', startAiProcessing);
        ui.clearAllBtn.addEventListener('click', clearAll);
        ui.copyMarkdownBtn.addEventListener('click', () => {
            copyToClipboard(ui.markdownOutput.value, ui.copyMarkdownBtn);
            logActivity(state.currentUser.name, state.currentUser.role, 'è¤‡è£½Markdown', 'è¤‡è£½AIæå–çµæœç‚ºMarkdown');
        });

        // API Key Modal
        ui.openApiKeyModalLink.addEventListener('click', () => ui.apiKeyModal.style.display = 'flex');
        ui.closeApiKeyModalBtn.addEventListener('click', () => ui.apiKeyModal.style.display = 'none');
        ui.apiKeyModal.addEventListener('click', e => { if (e.target === ui.apiKeyModal) ui.apiKeyModal.style.display = 'none'; });
    }

    function preventDefaults(e) { 
        e.preventDefault(); 
        e.stopPropagation(); 
    }
    
    // Display welcome message in results panel (now using markdownOutput)
    function showWelcomeScreen() {
        ui.markdownOutput.value = `æ­¡è¿ä½¿ç”¨çåŠ©å­¸é‡‘ç”³è«‹è³‡è¨Šç¥æå–ç³»çµ±ï¼
        
è«‹å°‡ PDF æˆ–åœ–ç‰‡æª”æ¡ˆæ‹–æ›³åˆ°å·¦å´çš„è™›ç·šæ¡†ä¸­ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆã€‚
ä¸Šå‚³æª”æ¡ˆå¾Œï¼Œå¡«å…¥æ‚¨çš„ Google Gemini API é‡‘é‘°ï¼Œç„¶å¾Œé»æ“Šã€Œé–‹å§‹AIç¥æå–ã€æŒ‰éˆ•ã€‚
AI æœƒè‡ªå‹•åˆ†ææ–‡ä»¶å…§å®¹ï¼Œä¸¦å°‡æå–åˆ°çš„çåŠ©å­¸é‡‘è³‡è¨Šæ•´ç†æˆ Markdown æ ¼å¼é¡¯ç¤ºåœ¨é€™è£¡ã€‚

ç¥æ‚¨çåŠ©å­¸é‡‘æ¥­å‹™é †åˆ©ï¼Œä½¿ç”¨æ„‰å¿«ï¼:)`;
        ui.markdownOutput.placeholder = 'AI æå–çµæœå°‡ä»¥ Markdown æ ¼å¼é¡¯ç¤ºæ–¼æ­¤ï¼Œæ‚¨å¯ä»¥ç·¨è¼¯å¾Œè¤‡è£½...';
        ui.copyMarkdownBtn.style.display = 'none'; // Hide copy button initially
    }

    // Process selected files from input or drag/drop
    function handleFiles(files) {
        if (!files || files.length === 0) {
            logStatus('æœªé¸æ“‡æª”æ¡ˆæˆ–å–æ¶ˆé¸æ“‡ã€‚', 'info');
            return;
        }
        for (const file of files) {
            if (!file.type.includes('pdf') && !file.type.includes('image')) {
                logStatus(`éŒ¯èª¤ï¼šæª”æ¡ˆ "${file.name}" ä¸æ˜¯ PDF æˆ–åœ–ç‰‡æ ¼å¼ï¼Œå·²å¿½ç•¥ã€‚`, 'error');
                continue;
            }
            const id = `file-${state.fileIdCounter++}`;
            state.files.set(id, { file, id, status: 'ç­‰å¾…è™•ç†', text: null, data: null });
            renderFileListItem(id);
            logStatus(`å·²åŠ å…¥æª”æ¡ˆ: ${file.name}`);
        }
        updateExtractionButtonState();
    }

    // Render a single file item in the file list
    function renderFileListItem(id) {
        const fileItem = state.files.get(id);
        const icon = fileItem.file.type.includes('pdf') ? 'fa-file-pdf' : 'fa-image';
        const newDiv = document.createElement('div');
        newDiv.id = `file-item-${id}`;
        newDiv.className = 'flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm';
        newDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${icon} text-red-500 mr-3"></i>
                <span class="text-sm font-medium text-gray-800 dark:text-gray-100">${fileItem.file.name}</span>
            </div>
            <div class="flex items-center gap-2">
                <span id="file-status-${id}" class="text-xs text-gray-500 dark:text-gray-300">${fileItem.status}</span>
                <button data-file-id="${id}" class="remove-file-btn text-gray-400 hover:text-red-500 text-lg leading-none">&times;</button>
            </div>
        `;
        ui.fileList.appendChild(newDiv);

        newDiv.querySelector('.remove-file-btn').addEventListener('click', (e) => {
            const fileId = e.target.dataset.fileId;
            const removedFileName = state.files.get(fileId)?.file.name || 'æœªçŸ¥æª”æ¡ˆ';
            state.files.delete(fileId);
            document.getElementById(`file-item-${fileId}`).remove();
            logStatus(`å·²ç§»é™¤æª”æ¡ˆ: ${removedFileName}`);
            logActivity(state.currentUser.name, state.currentUser.role, 'æª”æ¡ˆç§»é™¤', `ç§»é™¤æª”æ¡ˆ: ${removedFileName}`);
            updateExtractionButtonState();
            if (state.files.size === 0) {
                state.allExtractedResults = [];
                showWelcomeScreen(); // Go back to welcome if no files left
            }
        });
    }

    // Update status for a specific file item
    function updateFileStatus(id, status, type = 'info') {
        const fileItem = state.files.get(id);
        if (fileItem) {
            fileItem.status = status;
            const statusEl = document.getElementById(`file-status-${id}`);
            if (statusEl) {
                statusEl.textContent = status;
                statusEl.className = `text-xs mr-2 ${
                    type === 'error' ? 'text-red-600 dark:text-red-300' :
                    type === 'success' ? 'text-green-600 dark:text-green-300' :
                    'text-gray-700 dark:text-gray-200' // Default info status text color
                }`;
            }
        }
    }

    // Enable/disable buttons based on file list state
    function updateExtractionButtonState() {
        ui.startExtractionBtn.disabled = state.files.size === 0;
        ui.clearAllBtn.disabled = state.files.size === 0;
        document.querySelectorAll('.remove-file-btn').forEach(btn => btn.disabled = (state.files.size === 0));
    }

    // Clear all uploaded files and results
    async function clearAll() {
        if (state.files.size === 0 && state.allExtractedResults.length === 0) return;
        const numFiles = state.files.size;
        state.files.clear();
        state.fileIdCounter = 0;
        ui.fileList.innerHTML = '';
        ui.fileUpload.value = null;
        state.allExtractedResults = []; // Clear extracted results too
        logStatus('æ‰€æœ‰æª”æ¡ˆå’Œçµæœå·²æ¸…ç©ºã€‚');
        logActivity(state.currentUser.name, state.currentUser.role, 'æ¸…é™¤æ‰€æœ‰', `æ¸…ç©º ${numFiles} å€‹æª”æ¡ˆå’Œ AI çµæœ`);
        updateExtractionButtonState();
        showWelcomeScreen();
    }

    // Process a single file (PDF or Image) to extract text
    async function processFile(fileItem) {
        updateFileStatus(fileItem.id, 'è®€å–ä¸­...');
        logStatus(`æ­£åœ¨è™•ç†æª”æ¡ˆ: ${fileItem.file.name}`);
        let extractedText = '';

        try {
            if (fileItem.file.type.includes('pdf')) {
                const arrayBuffer = await fileItem.file.arrayBuffer();
                const pdf = await libraries.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                }
                extractedText = fullText.trim();
                if (extractedText) {
                    updateFileStatus(fileItem.id, 'PDFæ–‡å­—æå–å®Œæˆ', 'success');
                } else {
                    updateFileStatus(fileItem.id, 'PDFæœªæå–åˆ°æ–‡å­— (å¯èƒ½æ˜¯æƒæåœ–æª”)', 'error');
                    logStatus(`æª”æ¡ˆ ${fileItem.file.name}: PDF æœªæå–åˆ°æ–‡å­—å…§å®¹ã€‚å¯èƒ½æ˜¯æƒææ–‡ä»¶ï¼ŒAI æå–å¯èƒ½å—å½±éŸ¿ã€‚`, 'error');
                }
            } else if (fileItem.file.type.includes('image')) {
                updateFileStatus(fileItem.id, 'OCR è­˜åˆ¥ä¸­...');
                const { data: { text } } = await libraries.Tesseract.recognize(fileItem.file, 'chi_tra+eng'); // Supports Chinese and English
                extractedText = text.trim();
                updateFileStatus(fileItem.id, 'OCR è­˜åˆ¥å®Œæˆ', 'success');
            }
        } catch (error) {
            updateFileStatus(fileItem.id, `è®€å–æˆ–OCRå¤±æ•—: ${error.message}`, 'error');
            logStatus(`æª”æ¡ˆ ${fileItem.file.name} è™•ç†å¤±æ•—: ${error.message}`, 'error');
            return null;
        }

        fileItem.text = extractedText;
        return extractedText;
    }

    // Start AI processing for all uploaded files
    async function startAiProcessing() {
        const apiKey = ui.apiKeyInput.value.trim();
        if (!apiKey) {
            logStatus('éŒ¯èª¤ï¼šè«‹å…ˆè¼¸å…¥æ‚¨çš„ Google Gemini API é‡‘é‘°ã€‚', 'error');
            ui.apiKeyInput.focus();
            return;
        }
        if (state.files.size === 0) {
            logStatus('éŒ¯èª¤ï¼šæ²’æœ‰å¯è™•ç†çš„æª”æ¡ˆã€‚', 'error');
            return;
        }

        setButtonsState(true);
        ui.startExtractionBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> AI æå–ä¸­...`;
        ui.markdownOutput.value = ''; // Clear previous results
        ui.markdownOutput.placeholder = 'æ­£åœ¨æå–è³‡è¨Š...è«‹ç¨å€™...';
        ui.copyMarkdownBtn.style.display = 'none';

        state.allExtractedResults = []; // Clear previous AI results
        let totalScholarshipsExtracted = 0;

        for (const fileItem of state.files.values()) {
            const extractedText = await processFile(fileItem);
            if (!extractedText) {
                logStatus(`æª”æ¡ˆ ${fileItem.file.name} æœªèƒ½æå–åˆ°æ–‡å­—ï¼Œè·³é AI è™•ç†ã€‚`, 'error');
                continue;
            }
            if (extractedText.length < 50) { 
                 logStatus(`æª”æ¡ˆ ${fileItem.file.name} æå–åˆ°çš„æ–‡å­—éçŸ­ï¼Œå¯èƒ½å½±éŸ¿ AI çµæœã€‚`, 'info');
            }

            updateFileStatus(fileItem.id, 'AI åˆ†æä¸­...');
            logStatus(`æª”æ¡ˆ ${fileItem.file.name}: æ­£åœ¨è¯ç¹« AI é€²è¡Œè³‡è¨Šæå–...`);

            try {
                const aiResponse = await callGeminiApi(generateScholarshipPrompt(extractedText), apiKey);
                const parsedData = JSON.parse(aiResponse);

                const scholarships = Array.isArray(parsedData) ? parsedData : (parsedData ? [parsedData] : []);

                // Store full data, including original file name
                fileItem.data = scholarships;
                state.allExtractedResults.push(...scholarships.map(s => ({ ...s, sourceFile: fileItem.file.name })));
                totalScholarshipsExtracted += scholarships.length;
                
                updateFileStatus(fileItem.id, 'AI æå–å®Œæˆ', 'success');
                logStatus(`æª”æ¡ˆ ${fileItem.file.name}: AI è³‡è¨Šæå–æˆåŠŸã€‚`, 'success');
                logActivity(state.currentUser.name, state.currentUser.role, 'AIæå–æˆåŠŸ', `æª”æ¡ˆ "${fileItem.file.name}" AIæå–å®Œæˆï¼Œå…± ${scholarships.length} ç­†è³‡æ–™`);

            } catch (error) {
                fileItem.data = { error: error.message };
                updateFileStatus(fileItem.id, `AI æå–å¤±æ•—: ${error.message}`, 'error');
                logStatus(`æª”æ¡ˆ ${fileItem.file.name} AI æå–å¤±æ•—: ${error.message}`, 'error');
                logActivity(state.currentUser.name, state.currentUser.role, 'AIæå–å¤±æ•—', `æª”æ¡ˆ "${fileItem.file.name}" AIæå–å¤±æ•—: ${error.message}`);
            }
        }

        updateMarkdownOutputArea(state.allExtractedResults); 
        setButtonsState(false);
        ui.startExtractionBtn.innerHTML = `<i class="fa-solid fa-brain"></i> é–‹å§‹AIç¥æå–`;
        logStatus(`æ‰€æœ‰æª”æ¡ˆè™•ç†å®Œç•¢ã€‚å…±æå–åˆ° ${totalScholarshipsExtracted} ç­†çåŠ©å­¸é‡‘è³‡è¨Šã€‚`, 'success');
    }

    // Call Google Gemini API
    async function callGeminiApi(prompt, apiKey) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    temperature: 0.1, 
                    maxOutputTokens: 2048
                }
            })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
        }
        const data = await response.json();
        if (!data.candidates || data.candidates.length === 0) {
             throw new Error("API æœªè¿”å›æœ‰æ•ˆå…§å®¹ï¼Œå¯èƒ½è¢«å®‰å…¨éæ¿¾å™¨é˜»æ“‹æˆ–æ²’æœ‰æ‰¾åˆ°ç›¸é—œè³‡è¨Šã€‚");
        }
        return data.candidates[0].content.parts[0].text;
    }

    // Generate prompt for AI extraction
    function generateScholarshipPrompt(text) {
        return `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„çåŠ©å­¸é‡‘è³‡è¨Šæå–åŠ©æ‰‹ã€‚æˆ‘å°‡æä¾›ä½ å¾æ–‡ä»¶ï¼ˆPDFæˆ–åœ–ç‰‡ï¼‰ä¸­æå–çš„ç´”æ–‡å­—å…§å®¹ã€‚ä½ çš„ä»»å‹™æ˜¯å¾é€™äº›æ–‡å­—ä¸­æå–å‡ºç‰¹å®šçš„çåŠ©å­¸é‡‘è³‡è¨Šã€‚è«‹æ³¨æ„ï¼Œä¸€ä»½æ–‡ä»¶ä¸­å¯èƒ½åŒ…å«ä¸€å€‹æˆ–å¤šå€‹çåŠ©å­¸é‡‘çš„è³‡è¨Šã€‚

ä½ éœ€è¦æå–ä»¥ä¸‹å…­å€‹æ¬„ä½ï¼š
- **å…¬æ–‡æ–‡è™Ÿ (document_number)**: è©²çåŠ©å­¸é‡‘æˆ–é€šçŸ¥çš„æ­£å¼æ–‡ä»¶ç·¨è™Ÿã€‚å¦‚æœæ²’æœ‰æ˜ç¢ºæŒ‡å‡ºï¼Œè«‹å¡«å¯« nullã€‚
- **çåŠ©å­¸é‡‘åç¨± (scholarship_name)**: çåŠ©å­¸é‡‘çš„å®Œæ•´åç¨±ã€‚
- **ç”³è«‹è³‡æ ¼åŠæ¢ä»¶ (eligibility_criteria)**: ç”³è«‹äººå¿…é ˆç¬¦åˆçš„æ‰€æœ‰æ¢ä»¶ï¼Œä¾‹å¦‚å­¸æ¥­æˆç¸¾ã€å®¶åº­èƒŒæ™¯ã€ç‰¹å®šèº«ä»½ã€å­¸æ ¡ç§‘ç³»é™åˆ¶ç­‰ï¼Œè«‹ç›¡å¯èƒ½è©³ç´°ä½†ç°¡æ½”åœ°åˆ—å‡ºï¼Œä½¿ç”¨æ¢åˆ—å¼ã€‚
- **è£œåŠ©é‡‘é¡æˆ–è£œåŠ©å…§å®¹ (grant_details)**: çå­¸é‡‘çš„å…·é«”é‡‘é¡ã€å­¸é›œè²»æ¸›å…ã€ç”Ÿæ´»è²»è£œåŠ©æˆ–å…¶ä»–å¯¦ç‰©è£œåŠ©å…§å®¹ã€‚
- **æ ¡å…§æˆªæ­¢æ—¥æœŸ (internal_deadline)**: æ ¡å…§æäº¤ç”³è«‹çš„æˆªæ­¢æ—¥æœŸï¼Œè«‹ç›¡é‡æå–å…·é«”æ—¥æœŸ (æ ¼å¼ YYYY-MM-DD)ã€‚å¦‚æœæ²’æœ‰æ˜ç¢ºæŒ‡å‡ºï¼Œè«‹å¡«å¯« nullã€‚
- **ç”³è«‹æˆªæ­¢æ—¥æœŸ (application_deadline)**: æœ€çµ‚æäº¤ç”³è«‹çµ¦ä¸»è¾¦å–®ä½æˆ–å®˜æ–¹çš„æˆªæ­¢æ—¥æœŸï¼Œè«‹ç›¡é‡æå–å…·é«”æ—¥æœŸ (æ ¼å¼ YYYY-MM-DD)ã€‚å¦‚æœæ²’æœ‰æ˜ç¢ºæŒ‡å‡ºï¼Œè«‹å¡«å¯« nullã€‚

è«‹åš´æ ¼ä»¥ JSON é™£åˆ—çš„æ ¼å¼è¿”å›çµæœã€‚é™£åˆ—ä¸­çš„æ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€å€‹çåŠ©å­¸é‡‘çš„å®Œæ•´è³‡è¨Šã€‚å¦‚æœæŸå€‹æ¬„ä½è³‡è¨Šåœ¨åŸæ–‡ä¸­ä¸å­˜åœ¨ï¼Œè«‹å¡«å¯« \`null\`ã€‚è«‹ç¢ºä¿ JSON æ ¼å¼æ­£ç¢ºç„¡èª¤ã€‚

ç¯„ä¾‹ JSON è¼¸å‡ºæ ¼å¼ï¼š
\`\`\`json
[
  {
    "document_number": "æ–‡è™Ÿç¯„ä¾‹123",
    "scholarship_name": "ABC å¤§å­¸å„ªç§€æ–°ç”Ÿçå­¸é‡‘",
    "eligibility_criteria": [
      "é«˜ä¸­ç•¢æ¥­ç”Ÿï¼Œæˆç¸¾é”å…¨æ ¡å‰5%",
      "å®¶åº­å¹´æ”¶å…¥ä½æ–¼100è¬å…ƒ",
      "å…·å‚™é ˜å°æ½›è³ª"
    ],
    "grant_details": "æ–°å°å¹£ 50,000 å…ƒæ•´ï¼Œåˆ†å…©å­¸æœŸç™¼æ”¾",
    "internal_deadline": "2025-09-25",
    "application_deadline": "2025-09-30"
  },
  {
    "document_number": null,
    "scholarship_name": "æ¸…å¯’å­¸ç”Ÿç”Ÿæ´»è£œåŠ©é‡‘",
    "eligibility_criteria": [
      "å…·å‚™ä¸­è¯æ°‘åœ‹åœ‹ç±",
      "å®¶åº­ç¶“æ¿Ÿç‹€æ³ç¬¦åˆä½æ”¶å…¥æˆ¶æˆ–ä¸­ä½æ”¶å…¥æˆ¶æ¨™æº–",
      "å­¸æ¥­æˆç¸¾å¹³å‡é”70åˆ†ä»¥ä¸Š"
    ],
    "grant_details": "æ¯æœˆæ–°å°å¹£ 3,000 å…ƒï¼Œå…±è£œåŠ©12å€‹æœˆ",
    "internal_deadline": "2025-10-10",
    "application_deadline": "2025-10-15"
  }
]
\`\`\`

ä»¥ä¸‹æ˜¯å¾æ–‡ä»¶æå–çš„æ–‡å­—å…§å®¹ï¼š
---\n${text}\n---`;
    }

    // Helper to format date strings for display (client-side)
    function formatDate(dateString) {
        if (!dateString || dateString.toLowerCase() === 'null' || dateString === 'ç„¡' || dateString === '') return 'ç„¡'; // Just return "ç„¡" string for Markdown
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) { 
                return dateString; // Return original string if not a valid date
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        } catch (e) {
            console.error("Error formatting date:", dateString, e);
            return dateString;
        }
    }


    // Generates a Markdown string for a single scholarship item
    function formatSingleScholarshipAsMarkdown(data, index) {
        let markdown = `## ğŸ“âœ¨ ç¬¬ ${index + 1} ç­†çåŠ©å­¸é‡‘è³‡è¨Š ğŸ’°ğŸ“š\n\n`;
        markdown += `--- \n`;
        markdown += `ğŸ’– **çåŠ©å­¸é‡‘åç¨±**: ${data.scholarship_name || 'ç„¡'}\n`;
        markdown += `ğŸ“„ **å…¬æ–‡æ–‡è™Ÿ**: ${data.document_number || 'ç„¡'}\n`;
        markdown += `âœ… **ç”³è«‹è³‡æ ¼åŠæ¢ä»¶**:\n`;
        if (Array.isArray(data.eligibility_criteria) && data.eligibility_criteria.length > 0) {
            data.eligibility_criteria.forEach(item => {
                markdown += `  - ${item}\n`;
            });
        } else {
            markdown += `  - ç„¡\n`;
        }
        markdown += `ğŸ’° **è£œåŠ©é‡‘é¡æˆ–è£œåŠ©å…§å®¹**: ${data.grant_details || 'ç„¡'}\n`;
        markdown += `ğŸ« **æ ¡å…§æˆªæ­¢æ—¥æœŸ**: ${formatDate(data.internal_deadline) || 'ç„¡'}\n`; 
        markdown += `ğŸ“… **ç”³è«‹æˆªæ­¢æ—¥æœŸ**: ${formatDate(data.application_deadline) || 'ç„¡'}\n`; 
        markdown += `ğŸ“ **ä¾†æºæª”æ¡ˆ**: _${data.sourceFile || 'ç„¡'}_\n`;
        markdown += `--- \n\n`;
        return markdown;
    }


    // Updates the markdown output area with all extracted results
    function updateMarkdownOutputArea(results) {
        if (results.length === 0) {
            ui.markdownOutput.value = '';
            ui.markdownOutput.placeholder = 'æœªèƒ½å¾æª”æ¡ˆä¸­æå–åˆ°ä»»ä½•çåŠ©å­¸é‡‘è³‡è¨Šã€‚';
            ui.copyMarkdownBtn.style.display = 'none';
            return;
        }

        let fullMarkdown = '';
        results.forEach((item, index) => {
            fullMarkdown += formatSingleScholarshipAsMarkdown(item, index);
        });

        ui.markdownOutput.value = fullMarkdown;
        ui.markdownOutput.placeholder = 'AI æå–çµæœå·²é¡¯ç¤ºæ–¼æ­¤ï¼Œæ‚¨å¯ä»¥ç·¨è¼¯å¾Œè¤‡è£½...';
        ui.copyMarkdownBtn.style.display = 'inline-flex'; // Show copy button
    }


    // Helper function for copy to clipboard with visual feedback
    function copyToClipboard(text, buttonElement) {
        navigator.clipboard.writeText(text).then(() => {
            const originalIconHtml = buttonElement.innerHTML;
            const originalClasses = Array.from(buttonElement.classList);

            buttonElement.innerHTML = `<i class="fas fa-check"></i> è¤‡è£½æˆåŠŸ!`; 
            buttonElement.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white'); 
            buttonElement.classList.remove(...originalClasses.filter(cls => cls.startsWith('btn-secondary-custom'))); 

            setTimeout(() => {
                buttonElement.innerHTML = originalIconHtml; 
                buttonElement.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white'); 
                buttonElement.classList.add(...originalClasses.filter(cls => cls.startsWith('btn-secondary-custom'))); 
            }, 1500);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            const originalIconHtml = buttonElement.innerHTML;
            const originalClasses = Array.from(buttonElement.classList);

            buttonElement.innerHTML = `<i class="fas fa-times"></i> è¤‡è£½å¤±æ•—!`; 
            buttonElement.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white'); 
            buttonElement.classList.remove(...originalClasses.filter(cls => cls.startsWith('btn-secondary-custom'))); 
            
            setTimeout(() => {
                buttonElement.innerHTML = originalIconHtml; 
                buttonElement.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-white'); 
                buttonElement.classList.add(...originalClasses.filter(cls => cls.startsWith('btn-secondary-custom'))); 
            }, 1500);
        });
    }

    // Logging function for client-side demo (outputs to status log and console)
    function logStatus(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false });
        const logEntry = document.createElement('p');
        
        logEntry.className = `py-1`; 
        
        let messageTextColorClass = 'text-gray-700 dark:text-gray-200'; // Default text color for general info
        if (type === 'error') {
            messageTextColorClass = 'text-red-600 dark:text-red-300'; // Specific brighter color for errors in dark mode
        } else if (type === 'success') {
            messageTextColorClass = 'text-green-600 dark:text-green-300'; // Specific brighter color for success in dark mode
        }

        // Apply timestamp color and then message color
        logEntry.innerHTML = `<span class="text-gray-500 dark:text-gray-400">[${timestamp}]</span> <span class="${messageTextColorClass}">&gt; ${message}</span>`;
        ui.statusLog.appendChild(logEntry);
        ui.statusLog.scrollTop = ui.statusLog.scrollHeight; // Auto-scroll to bottom
        
        // Also log to console for debugging
        if (type === 'error') console.error(`[STATUS] ${message}`);
        else if (type === 'success') console.log(`[STATUS] ${message}`);
        else console.info(`[STATUS] ${message}`);
    }

    // Logging function for client-side demo (outputs to console only) - separate from status log
    function logActivity(userName, userRole, activityType, description) {
        const timestamp = new Date().toLocaleString('zh-TW', { hour12: false });
        console.log(`[ACTIVITY LOG - Frontend] ${timestamp} | User: ${userName} (${userRole}) | Type: ${activityType} | Desc: ${description}`);
    }
    
    // Helper to set buttons state (disabled/enabled)
    function setButtonsState(processing) {
        ui.fileUpload.disabled = processing;
        ui.startExtractionBtn.disabled = processing || state.files.size === 0;
        ui.clearAllBtn.disabled = processing;
        document.querySelectorAll('.remove-file-btn').forEach(btn => btn.disabled = processing);
    }

    // Call init when the DOM is fully loaded
    init();
});
</script>

</body>
</html>